[Unit]
Description=Chaos-Observatory (text-only global signal observatory)
Wants=network-online.target
After=network-online.target

# If you add local DB or mounts, you can extend with:
# RequiresMountsFor=/var/lib/chaos-observatory

[Service]
Type=oneshot

# Run as a dedicated service account (recommended)
User=chaos
Group=chaos

# Repo root (where config/, ingest/, analyze/, report/ live)
WorkingDirectory=/opt/chaos-observatory

# If you use a venv, point here
Environment="VIRTUAL_ENV=/opt/chaos-observatory/.venv"
Environment="PATH=/opt/chaos-observatory/.venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# Central config
Environment="CHAOS_CONFIG=/opt/chaos-observatory/config/chaos.yaml"

# Prefer predictable stdout/stderr
StandardOutput=journal
StandardError=journal

# Safety / hardening (tight but not fragile)
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ProtectControlGroups=true
ProtectKernelModules=true
ProtectKernelTunables=true
LockPersonality=true
MemoryDenyWriteExecute=true
RestrictSUIDSGID=true
RestrictNamespaces=true
RestrictRealtime=true

# Allow writing only where needed (adjust paths to your layout)
ReadWritePaths=/opt/chaos-observatory/data /opt/chaos-observatory/reports

# Network restrictions (RSS requires outbound HTTPS)
PrivateNetwork=false

# If you ever add DB sockets elsewhere, you may need:
# ReadWritePaths=/var/lib/chaos-observatory

# Main pipeline command:
# NOTE: This assumes you'll create bin/chaos_run.py (recommended orchestrator).
# For now, you can replace this ExecStart with the individual commands you want.
ExecStart=/bin/bash -lc '\
  set -euo pipefail; \
  echo "{\"event\":\"service_start\",\"ts_utc\":\"$(date -u +%FT%TZ)\"}"; \
  python3 ingest/rss_collector.py --sources ingest/sources.yaml --outdir data/raw; \
  DAY=$(date -u +%F); \
  mkdir -p "data/normalized/${DAY}"; \
  for f in "data/raw/${DAY}"/*.jsonl; do \
    [ -e "$f" ] || continue; \
    base=$(basename "$f"); \
    python3 ingest/normalize.py --in "$f" --out "data/normalized/${DAY}/${base}"; \
  done; \
  mkdir -p "reports/${DAY}"; \
  python3 report/weekly_report.py --normalized-dir data/normalized --outdir reports --window-days 7 --baseline-days 7; \
  python3 hold/retention.py --raw-dir data/raw --normalized-dir data/normalized --hold-days 7 --keep-days 30; \
  echo "{\"event\":\"service_done\",\"ts_utc\":\"$(date -u +%FT%TZ)\"}" \
'

# Timeouts / stability
TimeoutStartSec=30min

# If you want it to retry on transient failures:
# Restart=on-failure
# RestartSec=60

[Install]
WantedBy=multi-user.target









# 1) Create user
#sudo useradd --system --home /opt/chaos-observatory --shell /usr/sbin/nologin chaos || true
#sudo mkdir -p /opt/chaos-observatory
#sudo chown -R chaos:chaos /opt/chaos-observatory

# 2) Put repo at /opt/chaos-observatory (or change WorkingDirectory accordingly)
# 3) Place the unit:
#sudo cp systemd/chaos-observatory.service /etc/systemd/system/chaos-observatory.service

# 4) Reload systemd
#sudo systemctl daemon-reload

# 5) Test run
#sudo systemctl start chaos-observatory.service
#sudo journalctl -u chaos-observatory.service -n 200 --no-pager

# 6) Enable (it wonâ€™t run automatically without a timer/cron)
#sudo systemctl enable chaos-observatory.service
